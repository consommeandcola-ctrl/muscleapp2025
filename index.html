<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="ç­‹ãƒˆãƒ¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼" />
<meta name="theme-color" content="#f72585" />
<meta name="description" content="ç­‹ãƒˆãƒ¬è¨˜éŒ²ã‚’ç®¡ç†ã—ã€ç›®æ¨™é”æˆã§èŠ±ç«ãŒæ‰“ã¡ä¸ŠãŒã‚‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ—ãƒª" />
<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuevizjljqzjgq/jg6zjg7Pjg4Djg7wiLAogICJzaG9ydF9uYW1lIjogIuevizjljqzjgq/jg6zjg7Pjg4Djg7wiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZjZmNiIsCiAgInRoZW1lX2NvbG9yIjogIiNmNzI1ODUiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInJTNFJTNDcmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5MicgZmlsbD0nJTIzZjcyNTg1Jy8lM0UlM0N0ZXh0IHg9Jzk2JyB5PScxMjAnIGZvbnQtc2l6ZT0nODAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9JyNmZmYnJTNF8J+SqiUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc1MTInIGhlaWdodD0nNTEyJyUzRSUzQ3JlY3Qgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIGZpbGw9JyUyM2Y3MjU4NScvJTNFJTNDdGV4dCB4PSc2NTYnIHk9JzMyMCcgZm9udC1zaXplPScyMDAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9JyNmZmYnJTNF8J+SqiUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=" />
<title>ç­‹ãƒˆãƒ¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<style>
  :root{
    --bg1:#fff6f6; --bg2:#ffffff; --bg3:#f3f8ff;
    --text:#1f2a37; --muted:#6b7280; --line:#e5e7eb;
    --vivid-pink:#f72585; --vivid-orange:#ff8c00; --vivid-cyan:#2ec4b6; --vivid-blue:#2563eb; --gold:#ffd166;
    --cell-low:#c8f7ff; --cell-mid:#ffe28a; --cell-high:#ff8fa3;
    --glow-low:rgba(46,196,182,.45); --glow-mid:rgba(255,193,7,.50); --glow-high:rgba(255,107,107,.70);
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }
  html,body{height:100%; -webkit-touch-callout: none; -webkit-user-select: none;}
  body{
    margin:0; color:var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Helvetica Neue", Arial, "Noto Sans JP", "Yu Gothic UI", sans-serif;
    background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 45%, var(--bg3) 100%);
    padding-top: var(--safe-top);
    padding-bottom: var(--safe-bottom);
  }
  header{
    position:sticky; top:0; z-index:20; background:rgba(255,255,255,.95);
    backdrop-filter: blur(10px) saturate(1.2); border-bottom:1px solid var(--line);
  }
  .head-inner{
    max-width:100%; margin:0 auto; padding:8px 12px;
    display:flex; flex-wrap:wrap; gap:6px; align-items:center; justify-content:center;
  }
  .brand{
    font-weight:900; letter-spacing:.3px; white-space:nowrap; font-size:16px;
    background: linear-gradient(90deg, var(--vivid-blue), var(--vivid-pink), var(--vivid-orange));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; width:100%; text-align:center;
  }
  .user-badge{
    font-size:11px; padding:4px 8px; background:#eef2ff; border:1px solid #c7d2fe;
    border-radius:999px; color:#3730a3; font-weight:800; cursor:pointer;
  }
  .nav-row{display:flex; gap:4px; align-items:center; flex-wrap:wrap; justify-content:center;}
  .btn{
    appearance:none; border:1px solid var(--line); background:#fff; color:var(--text);
    padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:800; font-size:13px;
    white-space:nowrap; min-height:44px; /* ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆ */
  }
  .btn-primary{ color:#fff; border-color:transparent; background:linear-gradient(90deg, var(--vivid-blue), var(--vivid-pink)); }
  .btn-green{ color:#083; border-color:transparent; background: linear-gradient(90deg,#b7f9cc,#6ef3a8); }
  main{ max-width:100%; margin:0 auto; padding:12px 12px 90px; overflow-x:hidden;}

  .weekdayRow{display:grid;grid-template-columns:repeat(7,1fr);border-left:1px solid var(--line);border-top:1px solid var(--line);background:linear-gradient(180deg,#f7fbff,#fff)}
  .weekday{ text-align:center; padding:6px 2px; font-size:11px; font-weight:800; color:#475569;
            border-right:1px solid var(--line); border-bottom:1px solid var(--line); }
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);border-left:1px solid var(--line);border-bottom:1px solid var(--line)}
  .cell{
    border-right:1px solid var(--line);border-top:1px solid var(--line);
    min-height:70px; background:#fff;position:relative;cursor:pointer;transition:.12s;
    -webkit-tap-highlight-color: transparent;
  }
  .cell:active{transform:scale(0.98); background:#fafafa;}
  .dateNum{position:absolute;top:4px;right:4px;font-size:11px;font-weight:900;color:#64748b}
  .badge{position:absolute;left:4px;top:4px;font-size:9px;font-weight:800;padding:2px 5px;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
  .mini{position:absolute;left:4px;right:4px;bottom:20px;font-size:10px;color:#6b7280;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .bar{position:absolute;inset:auto 0 0 0;height:6px}
  .v-low{background:var(--cell-low)} .v-mid{background:var(--cell-mid)} .v-high{background:var(--cell-high)}
  .v-low.glow{ box-shadow: 0 0 8px var(--glow-low) inset, 0 0 10px var(--glow-low) }
  .v-mid.glow{ box-shadow: 0 0 8px var(--glow-mid) inset, 0 0 14px var(--glow-mid) }
  .v-high.glow{ box-shadow: 0 0 10px var(--glow-high) inset, 0 0 18px var(--glow-high) }

  .panel{margin-top:12px;background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
  .legend{display:flex;gap:8px;flex-wrap:wrap;font-size:11px;color:#6b7280;margin:6px 2px}
  .color{display:inline-block;width:16px;height:10px;border-radius:3px;margin-right:4px;border:1px solid var(--line)}

  dialog{border:none;border-radius:16px;padding:0;background:transparent; max-width:94vw;}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  .modal{background:#fff;border:1px solid var(--line);border-radius:16px;overflow:hidden;width:100%; max-height:90vh; overflow-y:auto;}
  .modal header{display:flex;align-items:center;gap:8px;padding:12px;border-bottom:1px solid var(--line)}
  .modal h3{margin:0;font-weight:900;font-size:16px;background:linear-gradient(90deg,#f72585,#ff8c00);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .modal .content{padding:12px;display:grid;gap:10px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:#6b7280; display:block; margin-bottom:4px;}
  input,select{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;font-size:15px;outline:none; box-sizing:border-box;}
  table{width:100%;border-collapse:collapse;font-size:12px; overflow-x:auto; display:block;}
  th,td{border-bottom:1px solid var(--line);padding:8px 4px;text-align:left; white-space:nowrap;}
  .right{text-align:right}
  .note{color:#6b7280;font-size:11px}
  .view-toggle{display:flex;gap:6px;margin:8px 0 4px; justify-content:center;}
  .toggle{
    border:1px solid var(--line);background:#fff;padding:8px 14px;border-radius:999px;
    cursor:pointer;font-weight:800;color:#374151; font-size:13px; min-height:44px;
    display:flex; align-items:center; -webkit-tap-highlight-color: transparent;
  }
  .toggle.active{color:#fff;background:linear-gradient(90deg, var(--vivid-blue), var(--vivid-pink));border:none}
  .totalHeader{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:6px; flex-direction:column;}
  .totalValue{font-weight:900;font-size:16px; text-align:center;}
  .goalTag{padding:4px 10px;border-radius:999px;background:#fff0c2;color:#7a4d00;font-weight:800;border:1px solid #ffd166; font-size:12px;}
  .achieved{background:#d1fadf;color:#065f46;border:1px solid #34d399}
  .toast{position:fixed;left:50%;top:68px;transform:translateX(-50%);background:#111827;color:#fff;border-radius:12px;padding:10px 14px;font-weight:900;display:none;z-index:50;box-shadow:0 10px 24px rgba(0,0,0,.25); font-size:13px;}
  
  /* èŠ±ç«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  #fireworksCanvas{
    position:fixed; top:0; left:0; width:100vw; height:100vh; 
    pointer-events:none; z-index:9999; display:none;
  }
  .achievement-msg{
    position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color:#fff; padding:24px 32px; border-radius:20px;
    font-size:28px; font-weight:900; z-index:10000;
    box-shadow:0 20px 60px rgba(0,0,0,.3);
    display:none; animation:achievePop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    text-align:center; border:3px solid rgba(255,255,255,.3);
  }
  @keyframes achievePop{
    0%{transform:translate(-50%, -50%) scale(0); opacity:0;}
    50%{transform:translate(-50%, -50%) scale(1.1);}
    100%{transform:translate(-50%, -50%) scale(1); opacity:1;}
  }
  @keyframes pulse{
    0%, 100%{transform:scale(1); box-shadow:0 2px 8px rgba(0,0,0,.1);}
    50%{transform:scale(1.05); box-shadow:0 4px 16px rgba(247,37,133,.4);}
  }
  .achievement-msg .emoji{font-size:48px; display:block; margin-bottom:8px;}
  
  /* ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .user-input-box{text-align:center; padding:20px;}
  .user-input-box input{max-width:300px; margin:12px auto; display:block;}
  .user-actions{display:flex; gap:8px; justify-content:center; margin-top:12px;}
  
  /* ãƒãƒ£ãƒ¼ãƒˆèª¿æ•´ */
  canvas{max-width:100%; touch-action: pan-y;}
</style>
</head>
<body>
  <header>
    <div class="head-inner">
      <div class="brand">ğŸ’ª ç­‹ãƒˆãƒ¬ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
      <div id="userBadge" class="user-badge" style="display:none"></div>
      <div class="nav-row">
        <button id="btnPrev" class="btn">ã€ˆ å‰æœˆ</button>
        <div id="monthLabel" style="font-weight:900; font-size:14px;"></div>
        <button id="btnNext" class="btn">ç¿Œæœˆ ã€‰</button>
      </div>
      <div class="nav-row">
        <button id="btnToday" class="btn">ä»Šæ—¥ã¸</button>
        <button id="btnAddToday" class="btn btn-primary">ï¼‹ ä»Šæ—¥</button>
        <button id="btnSettings" class="btn btn-green">âš™</button>
      </div>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="legend">
        <span><span class="color" style="background:var(--cell-low)"></span>è»½ã‚</span>
        <span><span class="color" style="background:var(--cell-mid)"></span>ä¸­</span>
        <span><span class="color" style="background:var(--cell-high)"></span>é«˜</span>
        <span class="note">â€»kg = è·é‡Ã—å›Ã—ã‚»ãƒƒãƒˆ</span>
      </div>
      <div class="weekdayRow">
        <div class="weekday">æ—¥</div><div class="weekday">æœˆ</div><div class="weekday">ç«</div>
        <div class="weekday">æ°´</div><div class="weekday">æœ¨</div><div class="weekday">é‡‘</div><div class="weekday">åœŸ</div>
      </div>
      <div id="calendar" class="calendar"></div>
    </section>

    <section class="panel">
      <div class="totalHeader">
        <div class="view-toggle">
          <button class="toggle active" data-mode="day">æ—¥</button>
          <button class="toggle" data-mode="week">é€±</button>
          <button class="toggle" data-mode="month">æœˆ</button>
        </div>
        <div id="totalLabel" class="totalValue">ç·é‡ï¼š- kg</div>
        <div id="goalTag" class="goalTag">ç›®æ¨™ï¼š- kg</div>
        <div id="periodLabel" class="note"></div>
      </div>
      <canvas id="totalBar" height="90" style="margin-bottom:12px"></canvas>
      <canvas id="muscleBars" height="280"></canvas>
    </section>
  </main>

  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog id="dlgUser">
    <div class="modal">
      <header>
        <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼IDç®¡ç†</h3>
        <div style="flex:1"></div>
        <button id="btnCloseUser" class="btn">âœ•</button>
      </header>
      <div class="content user-input-box">
        <p style="font-size:13px; color:#6b7280;">ã‚ãªãŸã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>åŒã˜IDã§åˆ¥ç«¯æœ«ã‹ã‚‰ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã§ãã¾ã™ã€‚</p>
        <input type="text" id="userIdInput" placeholder="ä¾‹: taro_yamada_001" maxlength="50" />
        <div class="user-actions">
          <button id="btnSaveUserId" class="btn btn-primary">ä¿å­˜</button>
          <button id="btnChangeUserId" class="btn" style="display:none">IDå¤‰æ›´</button>
        </div>
        <p class="note" style="margin-top:16px;">â€»IDã¯ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã€ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«ä½¿ç”¨ã•ã‚Œã¾ã™</p>
      </div>
    </div>
  </dialog>

  <!-- è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog id="dlg">
    <div class="modal">
      <header>
        <h3 id="dlgTitle">è¨˜éŒ²</h3>
        <div style="flex:1"></div>
        <button id="btnClose" class="btn">âœ•</button>
      </header>
      <div class="content">
        <div id="existingList"></div>
        <hr style="border:none; border-top:1px solid var(--line); margin:8px 0">
        <label>ç¨®ç›®</label>
        <select id="selExercise"></select>
        <div class="row">
          <div><label>ã‚»ãƒƒãƒˆæ•°</label><input id="inSets" type="number" value="3" min="1"/></div>
          <div><label>å›æ•°</label><input id="inReps" type="number" value="10" min="1"/></div>
        </div>
        <div id="weightBox">
          <label>é‡é‡ï¼ˆkgï¼‰</label>
          <input id="inWeight" type="number" value="0" step="0.5" min="0"/>
        </div>
        <button id="btnAdd" class="btn btn-primary" style="width:100%">è¿½åŠ </button>
      </div>
    </div>
  </dialog>

  <!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog id="dlgSettings">
    <div class="modal">
      <header>
        <h3>âš™ è¨­å®š</h3>
        <div style="flex:1"></div>
        <button id="btnCloseSettings" class="btn">âœ•</button>
      </header>
      <div class="content">
        <div><label>ä½“é‡ï¼ˆkgï¼‰</label><input id="inBodyWeight" type="number" step="0.1" min="1"/></div>
        <div class="row">
          <div><label>æ—¥ç›®æ¨™ï¼ˆkgï¼‰</label><input id="inGoalDay" type="number" step="100" min="0"/></div>
          <div><label>é€±ç›®æ¨™ï¼ˆkgï¼‰</label><input id="inGoalWeek" type="number" step="500" min="0"/></div>
        </div>
        <div><label>æœˆç›®æ¨™ï¼ˆkgï¼‰</label><input id="inGoalMonth" type="number" step="1000" min="0"/></div>
        
        <hr style="border:none; border-top:1px solid var(--line); margin:12px 0">
        <h4 style="font-size:14px; margin:8px 0">ç¨®ç›®ç®¡ç†</h4>
        <div id="exerciseChips" style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px"></div>
        
        <button id="btnRestoreDefaultEx" class="btn" style="width:100%; margin-bottom:8px;">ğŸ”„ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨®ç›®ã‚’å¾©å…ƒ</button>
        
        <details id="addExerciseDetails" style="border:1px solid var(--line); border-radius:12px; padding:10px; margin-top:8px;">
          <summary style="cursor:pointer; font-weight:800; font-size:13px;">æ–°è¦ç¨®ç›®è¿½åŠ </summary>
          <div style="margin-top:12px; display:grid; gap:10px;">
            <div>
              <label>ç¨®ç›®å</label>
              <input id="newExLabel" placeholder="ä¾‹ï¼šãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹" />
            </div>
            <div>
              <label>ç¨®åˆ¥</label>
              <select id="newExType">
                <option value="weight">ã‚¦ã‚§ã‚¤ãƒˆç¨®ç›®</option>
                <option value="bodyweight">è‡ªé‡ç¨®ç›®</option>
              </select>
            </div>
            <div id="bwCoefBox" style="display:none">
              <label>è‡ªé‡ä¿‚æ•°ï¼ˆ0.0ã€œ1.0ï¼‰</label>
              <input id="newExBwCoef" type="number" step="0.05" value="0.6" min="0" max="1"/>
              <div class="note">â€»ä½“é‡ã«æ›ã‘ã‚‹ä¿‚æ•°ï¼ˆè…•ç«‹ã¦ä¼ã›â‰’0.6ã€æ‡¸å‚â‰’1.0ï¼‰</div>
            </div>
            
            <hr style="border:none; border-top:1px solid var(--line); margin:8px 0">
            
            <div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <label style="margin:0;">ä½¿ç”¨ã™ã‚‹ç­‹è‚‰ã‚’é¸æŠ</label>
                <span id="muscleTotal" class="note">åˆè¨ˆ: 0%</span>
              </div>
              <div id="muscleSelector" style="display:grid; gap:6px; max-height:300px; overflow-y:auto; padding:8px; background:#f9fafb; border-radius:8px; border:1px solid var(--line);"></div>
              <div class="note" style="margin-top:6px;">â€»å‰²åˆã¯è‡ªå‹•ã§æ­£è¦åŒ–ã•ã‚Œã¾ã™ï¼ˆåˆè¨ˆ100%ã«èª¿æ•´ï¼‰</div>
            </div>
            
            <button id="btnAddExercise" class="btn btn-primary">ç¨®ç›®è¿½åŠ </button>
          </div>
        </details>
        
        <hr style="border:none; border-top:1px solid var(--line); margin:12px 0">
        <h4 style="font-size:14px; margin:8px 0">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h4>
        <div class="note" style="padding:8px; background:#fef3c7; border:1px solid #fcd34d; border-radius:8px; margin-bottom:8px;">
          âš ï¸ ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚Safariã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚„ã‚¢ãƒ—ãƒªå‰Šé™¤ã§æ¶ˆãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å®šæœŸçš„ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’å¼·ããŠå‹§ã‚ã—ã¾ã™ã€‚
        </div>
        <div style="display:grid; gap:8px;">
          <button id="btnExport" class="btn">ğŸ’¾ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <label class="btn" style="text-align:center; margin:0;">
            ğŸ“‚ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            <input type="file" id="importFile" accept=".json" style="display:none"/>
          </label>
          <button id="btnManageUser" class="btn btn-green">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDç®¡ç†</button>
          <button id="btnResetAchievements" class="btn" style="background:#fef3c7; color:#92400e; border-color:#fcd34d;">ğŸ¯ é”æˆè¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="btnTestFireworks" class="btn" style="background:#e0e7ff; color:#3730a3; border-color:#c7d2fe;">ğŸ† èŠ±ç«ãƒ†ã‚¹ãƒˆ</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- ç¨®ç›®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <dialog id="dlgEditExercise">
    <div class="modal">
      <header>
        <h3 id="editExTitle">ç¨®ç›®ç·¨é›†</h3>
        <div style="flex:1"></div>
        <button id="btnCloseEditEx" class="btn">âœ•</button>
      </header>
      <div class="content">
        <div>
          <label>ç¨®ç›®å</label>
          <input id="editExLabel" />
        </div>
        <div>
          <label>ç¨®åˆ¥</label>
          <select id="editExType" disabled style="background:#f3f4f6; cursor:not-allowed;">
            <option value="weight">ã‚¦ã‚§ã‚¤ãƒˆç¨®ç›®</option>
            <option value="bodyweight">è‡ªé‡ç¨®ç›®</option>
          </select>
          <div class="note">â€»ç¨®åˆ¥ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>
        </div>
        <div id="editBwCoefBox" style="display:none">
          <label>è‡ªé‡ä¿‚æ•°ï¼ˆ0.0ã€œ1.0ï¼‰</label>
          <input id="editExBwCoef" type="number" step="0.05" min="0" max="1"/>
        </div>
        
        <hr style="border:none; border-top:1px solid var(--line); margin:8px 0">
        
        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <label style="margin:0;">ä½¿ç”¨ã™ã‚‹ç­‹è‚‰</label>
            <span id="editMuscleTotal" class="note">åˆè¨ˆ: 0%</span>
          </div>
          <div id="editMuscleSelector" style="display:grid; gap:6px; max-height:300px; overflow-y:auto; padding:8px; background:#f9fafb; border-radius:8px; border:1px solid var(--line);"></div>
          <div class="note" style="margin-top:6px;">â€»å‰²åˆã¯è‡ªå‹•ã§æ­£è¦åŒ–ã•ã‚Œã¾ã™ï¼ˆåˆè¨ˆ100%ã«èª¿æ•´ï¼‰</div>
        </div>
        
        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="btnSaveEditEx" class="btn btn-primary" style="flex:1;">ä¿å­˜</button>
          <button id="btnDeleteEditEx" class="btn" style="background:#fee; color:#c00; border-color:#fcc;">å‰Šé™¤</button>
        </div>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast"></div>
  
  <!-- èŠ±ç«æ¼”å‡º -->
  <canvas id="fireworksCanvas"></canvas>
  <div id="achievementMsg" class="achievement-msg">
    <span class="emoji">ğŸ‰</span>
    <div id="achieveText">ç›®æ¨™é”æˆï¼</div>
  </div>

  <!-- Chart.js & annotation plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
  /* ====== ã‚·ãƒ§ãƒ¼ãƒˆãƒãƒ³ãƒ‰ ====== */
  const $=(s)=>document.querySelector(s), $$=(s)=>document.querySelectorAll(s);
  const todayISO=()=>toISO(new Date()), toISO=(d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  const fromISO=(iso)=>{ const [y,m,d]=iso.split("-").map(Number); return new Date(y,m-1,d); };
  function weekRangeFromDate(d){ const date=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const day=date.getDay(); const start=new Date(date); start.setDate(date.getDate()-day); const end=new Date(start); end.setDate(start.getDate()+6); return {start,end}; }

  /* ====== ãƒ¦ãƒ¼ã‚¶ãƒ¼IDç®¡ç† ====== */
  let currentUserId = localStorage.getItem('muscle_calendar_user_id') || '';
  
  function showUserIdModal(){
    $("#userIdInput").value = currentUserId;
    $("#btnChangeUserId").style.display = currentUserId ? 'block' : 'none';
    $("#dlgUser").showModal();
  }
  
  function saveUserId(){
    const id = $("#userIdInput").value.trim();
    if(!id){
      toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    currentUserId = id;
    localStorage.setItem('muscle_calendar_user_id', id);
    updateUserBadge();
    $("#dlgUser").close();
    toast('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ä¿å­˜ã—ã¾ã—ãŸ');
  }
  
  function updateUserBadge(){
    if(currentUserId){
      $("#userBadge").textContent = 'ğŸ‘¤ ' + currentUserId;
      $("#userBadge").style.display = 'block';
    } else {
      $("#userBadge").style.display = 'none';
    }
  }
  
  $("#btnCloseUser").addEventListener('click', ()=>$("#dlgUser").close());
  $("#btnSaveUserId").addEventListener('click', saveUserId);
  $("#btnChangeUserId").addEventListener('click', showUserIdModal);
  $("#btnManageUser").addEventListener('click', showUserIdModal);
  $("#userBadge").addEventListener('click', showUserIdModal);

  /* ====== IndexedDBï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDåˆ¥ã«ç®¡ç†ï¼‰ ====== */
  let db=null;
  function getDbName(){
    return currentUserId ? `WorkoutDB_${currentUserId}` : 'WorkoutDB_default';
  }
  
  async function openDB(){
    return new Promise((res,rej)=>{
      const req=indexedDB.open(getDbName(),1);
      req.onupgradeneeded=(e)=>{
        const d=e.target.result;
        if(!d.objectStoreNames.contains('entries')) d.createObjectStore('entries',{keyPath:'date'});
        if(!d.objectStoreNames.contains('exercises')){
          const ex = d.createObjectStore('exercises',{keyPath:'id'});
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨®ç›®ã‚’è‡ªå‹•ç™»éŒ²
          DEFAULT_EXERCISES.forEach(x=>ex.put(x));
        }
      };
      req.onsuccess=()=>res(req.result);
      req.onerror=()=>rej(req.error);
    });
  }
  
  async function reopenDB(){
    if(db) db.close();
    db = await openDB();
  }

  /* è¨­å®šãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDåˆ¥ï¼‰ */
  let settings = {};
  function loadSettings(){
    const key = currentUserId ? `settings_${currentUserId}` : 'settings_default';
    const stored = localStorage.getItem(key);
    settings = stored ? JSON.parse(stored) : {body_weight:70, last_date:todayISO()};
  }
  function saveSettings(){
    const key = currentUserId ? `settings_${currentUserId}` : 'settings_default';
    localStorage.setItem(key, JSON.stringify(settings));
  }

  /* ç¨®ç›® */
  function tx(name,mode){ return db.transaction(name,mode).objectStore(name); }
  const exAll = ()=>new Promise((res,rej)=>{ const r=tx('exercises','readonly').getAll(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });
  const exGet = (id)=>new Promise((res,rej)=>{ const r=tx('exercises','readonly').get(id); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); });
  const exPut = (obj)=>new Promise((res,rej)=>{ const r=tx('exercises','readwrite').put(obj); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); });
  const exDel = (id)=>new Promise((res,rej)=>{ const r=tx('exercises','readwrite').delete(id); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); });

  /* ã‚¨ãƒ³ãƒˆãƒª */
  const entryGet = (iso)=>new Promise((res,rej)=>{ const r=tx('entries','readonly').get(iso); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error); });
  const entryPut = (obj)=>new Promise((res,rej)=>{ const r=tx('entries','readwrite').put(obj); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); });
  const entryDel = (iso)=>new Promise((res,rej)=>{ const r=tx('entries','readwrite').delete(iso); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); });
  const allEntries = ()=>new Promise((res,rej)=>{ const r=tx('entries','readonly').getAll(); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error); });

  /* ====== ç­‹è‚‰å®šç¾©ï¼ˆå›ºå®šé †åºï¼šé ­â†’è„šï¼‰ ====== */
  const MUSCLE_ORDER = [
    'scm','trap','delt_ant','delt_mid','delt_post',
    'pec','biceps','triceps','brachiorad','foreflex','foreext',
    'lat','erector',
    'rectabd','oblique','iliopsoas',
    'glute','quad','ham','gast','soleus'
  ];
  
  const MUSCLES = {
    trap:'åƒ§å¸½ç­‹', lat:'åºƒèƒŒç­‹', erector:'è„ŠæŸ±èµ·ç«‹ç­‹',
    biceps:'ä¸Šè…•äºŒé ­ç­‹', triceps:'ä¸Šè…•ä¸‰é ­ç­‹', brachiorad:'è…•æ©ˆéª¨ç­‹',
    foreflex:'å‰è…•å±ˆç­‹ç¾¤', foreext:'å‰è…•ä¼¸ç­‹ç¾¤',
    delt_ant:'ä¸‰è§’ç­‹å‰éƒ¨', delt_mid:'ä¸‰è§’ç­‹ä¸­éƒ¨', delt_post:'ä¸‰è§’ç­‹å¾Œéƒ¨',
    pec:'å¤§èƒ¸ç­‹',
    rectabd:'è…¹ç›´ç­‹', oblique:'å¤–è…¹æ–œç­‹', iliopsoas:'è…¸è…°ç­‹',
    scm:'èƒ¸é–ä¹³çªç­‹',
    glute:'å¤§è‡€ç­‹',
    quad:'å¤§è…¿å››é ­ç­‹', ham:'å¤§è…¿äºŒé ­ç­‹',
    gast:'è…“è…¹ç­‹', soleus:'ãƒ’ãƒ©ãƒ¡ç­‹'
  };
  
  const MUSCLE_COLORS = {
    trap:'#ff4d4d', lat:'#ff865e', erector:'#c77dff',
    biceps:'#ffa600', triceps:'#36b37e', brachiorad:'#00b8d9',
    foreflex:'#5e60ce', foreext:'#3a86ff',
    delt_ant:'#fb5607', delt_mid:'#ff006e', delt_post:'#8338ec',
    pec:'#2e90fa',
    rectabd:'#ef476f', oblique:'#ffd166', iliopsoas:'#06d6a0',
    scm:'#118ab2',
    glute:'#8ac926',
    quad:'#ff9f1c', ham:'#9b5de5',
    gast:'#00bbf9', soleus:'#00f5d4'
  };

  /* ====== ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨®ç›® ====== */
  const DEFAULT_EXERCISES = [
    { id:'pullup', label:'æ‡¸å‚', type:'bodyweight', bw_factor:1.00, muscles:{ lat:.40, biceps:.25, trap:.15, brachiorad:.10, foreflex:.10 } },
    { id:'frontlever', label:'ãƒ•ãƒ­ãƒ³ãƒˆãƒ¬ãƒãƒ¼', type:'bodyweight', bw_factor:0.80, muscles:{ lat:.35, delt_post:.20, biceps:.15, erector:.10, rectabd:.10, foreflex:.10 } },
    { id:'muscleup', label:'ãƒãƒƒã‚¹ãƒ«ã‚¢ãƒƒãƒ—', type:'bodyweight', bw_factor:1.10, muscles:{ lat:.30, biceps:.20, trap:.10, pec:.15, triceps:.15, delt_ant:.10 } },
    { id:'sbdips', label:'ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒãƒ¼ãƒ‡ã‚£ãƒƒãƒ—ã‚¹', type:'bodyweight', bw_factor:0.85, muscles:{ pec:.40, triceps:.35, delt_ant:.20, foreflex:.05 } },
    { id:'pdips', label:'ãƒ‘ãƒ©ãƒ¬ãƒ«ãƒãƒ¼ãƒ‡ã‚£ãƒƒãƒ—ã‚¹', type:'bodyweight', bw_factor:0.85, muscles:{ pec:.42, triceps:.38, delt_ant:.18, foreflex:.02 } },
    { id:'planchelean', label:'ãƒ—ãƒ©ãƒ³ã‚·ã‚§ãƒªãƒ¼ãƒ³', type:'bodyweight', bw_factor:0.70, muscles:{ pec:.40, delt_ant:.30, triceps:.20, foreflex:.05, rectabd:.05 } },
    { id:'pushup', label:'è…•ç«‹ã¦ä¼ã›', type:'bodyweight', bw_factor:0.60, muscles:{ pec:.45, triceps:.30, delt_ant:.15, rectabd:.10 } },
    { id:'legraise', label:'ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º', type:'bodyweight', bw_factor:0.30, muscles:{ rectabd:.60, iliopsoas:.30, oblique:.10 } },
    { id:'dragonflag', label:'ãƒ‰ãƒ©ã‚´ãƒ³ãƒ•ãƒ©ãƒƒã‚°', type:'bodyweight', bw_factor:0.50, muscles:{ rectabd:.50, erector:.15, oblique:.15, lat:.10, delt_ant:.10 } },
    { id:'hkneeraises', label:'ãƒãƒ³ã‚®ãƒ³ã‚°ãƒ‹ãƒ¼ãƒ¬ã‚¤ã‚º', type:'bodyweight', bw_factor:0.35, muscles:{ rectabd:.55, iliopsoas:.35, oblique:.10 } },
    { id:'squat', label:'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆï¼ˆãƒãƒ¼ãƒ™ãƒ«ï¼‰', type:'weight', muscles:{ quad:.45, glute:.30, ham:.15, erector:.07, gast:.03 } },
    { id:'deadlift', label:'ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ', type:'weight', muscles:{ erector:.30, ham:.30, glute:.25, trap:.10, foreflex:.05 } },
    { id:'bench', label:'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹', type:'weight', muscles:{ pec:.55, triceps:.25, delt_ant:.18, biceps:.02 } }
  ];

  /* ====== ç›®æ¨™å€¤ ====== */
  let GOAL = {day:2000, week:15000, month:70000};
  function loadGoals(){
    GOAL.day = settings.goal_day ?? 2000;
    GOAL.week = settings.goal_week ?? 15000;
    GOAL.month = settings.goal_month ?? 70000;
  }
  function saveGoals(){
    settings.goal_day = GOAL.day;
    settings.goal_week = GOAL.week;
    settings.goal_month = GOAL.month;
    saveSettings();
  }

  /* ====== è¨ˆç®— ====== */
  function calc_item_effective_load(item, bw, ex){ 
    return ex.type==='bodyweight' ? (ex.bw_factor ?? 0.6)*bw : bw + Number(item.weight_kg||0); 
  }
  function calc_item_volume(item, bw, ex){ 
    const s=+item.sets||0, r=+item.reps||0; 
    if(!s||!r) return 0; 
    return calc_item_effective_load(item,bw,ex)*s*r; 
  }
  function muscle_load_for_day(items, bw, exs){
    const acc={}; 
    items.forEach(it=>{ 
      const ex=exs.find(e=>e.id===it.exercise_id); 
      if(!ex) return;
      const vol=calc_item_volume(it,bw,ex); 
      const dist=ex.muscles||{}; 
      const sum=Object.values(dist).reduce((a,b)=>a+b,0)||1;
      for(const [k,r] of Object.entries(dist)){ 
        acc[k]=(acc[k]||0)+vol*(r/sum); 
      }
    }); 
    return acc;
  }

  async function rangeLoads(mode, pivotISO){
    const exs = await exAll(); 
    const bw = settings.body_weight||70; 
    const all = await allEntries();
    let start, end, label;
    
    if(mode==='day'){ 
      const d=fromISO(pivotISO); 
      start=new Date(d); 
      end=new Date(d); 
      label=`ï¼ˆ${pivotISO}ï¼‰`; 
    }
    else if(mode==='week'){ 
      const d=fromISO(pivotISO); 
      const w=weekRangeFromDate(d); 
      start=w.start; 
      end=w.end; 
      label=`ï¼ˆé€±ï¼š${toISO(start)}ã€œ${toISO(end)}ï¼‰`; 
    }
    else { 
      const d=fromISO(pivotISO); 
      start=new Date(d.getFullYear(),d.getMonth(),1); 
      end=new Date(d.getFullYear(),d.getMonth()+1,0); 
      label=`ï¼ˆæœˆï¼š${d.getFullYear()}å¹´${d.getMonth()+1}æœˆï¼‰`; 
    }

    const loads={};
    all.forEach(rec=>{ 
      const dt=fromISO(rec.date); 
      if(dt>=start && dt<=end){
        const mld = muscle_load_for_day(rec.items||[], bw, exs);
        for(const [k,v] of Object.entries(mld)) loads[k]=(loads[k]||0)+v;
      }
    });
    
    const totalLoad = Object.values(loads).reduce((a,b)=>a+b,0);
    return { loads, totalLoad, label };
  }

  /* ====== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ====== */
  let view = {year:new Date().getFullYear(), month:new Date().getMonth()};
  
  async function renderCalendar(){
    const cal=$("#calendar"), y=view.year, m=view.month;
    $("#monthLabel").textContent = `${y}å¹´ ${m+1}æœˆ`;
    const first=new Date(y,m,1).getDay(), last=new Date(y,m+1,0).getDate();
    cal.innerHTML='';
    
    for(let i=0; i<first; i++){
      const c=document.createElement('div'); c.className='cell'; cal.appendChild(c);
    }
    
    const exs=await exAll();
    const bw = settings.body_weight||70;
    
    for(let d=1; d<=last; d++){
      const dateStr=toISO(new Date(y,m,d));
      const entry=await entryGet(dateStr);
      const c=document.createElement('div'); c.className='cell';
      const num=document.createElement('div'); num.className='dateNum'; num.textContent=d; c.appendChild(num);
      
      if(entry && entry.items && entry.items.length){
        let totalVol = 0;
        entry.items.forEach(it=>{
          const ex = exs.find(e=>e.id===it.exercise_id);
          if(ex) totalVol += calc_item_volume(it, bw, ex);
        });
        
        const badge=document.createElement('div'); badge.className='badge'; badge.textContent=entry.items.length+'ç¨®'; c.appendChild(badge);
        const mini=document.createElement('div'); mini.className='mini'; mini.textContent=Math.round(totalVol)+' kg'; c.appendChild(mini);
        const bar=document.createElement('div'); bar.className='bar';
        if(totalVol<800){bar.classList.add('v-low')} else if(totalVol<1500){bar.classList.add('v-mid')} else {bar.classList.add('v-high','glow')}
        c.appendChild(bar);
      }
      
      c.addEventListener('click', ()=>{ openDayModal(dateStr); settings.last_date=dateStr; saveSettings(); renderTotalAndMuscleCharts(currentMode, dateStr); });
      cal.appendChild(c);
    }
  }

  /* ====== è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
  let editingDate='';
  async function openDayModal(date){
    editingDate=date; 
    $("#dlgTitle").textContent=`ğŸ“… ${date}`;
    const entry=await entryGet(date);
    const list=$("#existingList"); 
    list.innerHTML='';
    
    if(entry && entry.items && entry.items.length){
      const tbl=document.createElement('table');
      tbl.innerHTML='<thead><tr><th>ç¨®ç›®</th><th>ã‚»ãƒƒãƒˆ</th><th>å›æ•°</th><th class="right">é‡é‡</th><th></th></tr></thead><tbody></tbody>';
      const tbody=tbl.querySelector('tbody');
      for(const it of entry.items){
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${it.exercise_label||'-'}</td><td>${it.sets||0}</td><td>${it.reps||0}</td><td class="right">${it.weight_kg||0} kg</td><td></td>`;
        const delBtn=document.createElement('button'); delBtn.className='btn'; delBtn.textContent='å‰Šé™¤';
        delBtn.addEventListener('click', async()=>{ 
          await removeItem(date, it.id); 
          openDayModal(date); 
          renderCalendar(); 
          renderTotalAndMuscleCharts(currentMode, date); 
        });
        tr.lastElementChild.appendChild(delBtn);
        tbody.appendChild(tr);
      }
      list.appendChild(tbl);
    } else {
      list.innerHTML='<div class="note">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    }
    $("#dlg").showModal();
  }

  async function removeItem(date, itemId){
    const entry=await entryGet(date);
    if(!entry) return;
    entry.items = (entry.items||[]).filter(x=>x.id!==itemId);
    await entryPut(entry);
    toast('å‰Šé™¤ã—ã¾ã—ãŸ');
  }

  $("#btnClose").addEventListener('click', ()=>$("#dlg").close());
  $("#btnAdd").addEventListener('click', async()=>{
    const exId=$("#selExercise").value; 
    if(!exId){ toast('ç¨®ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    const ex=await exGet(exId); 
    if(!ex) return;
    const sets=+($("#inSets").value||1), reps=+($("#inReps").value||1), w=+($("#inWeight").value||0);
    const item={
      id:'item_'+Math.random().toString(36).slice(2,9), 
      exercise_id:ex.id, 
      exercise_label:ex.label, 
      sets, 
      reps, 
      weight_kg:w, 
      created_at:Date.now()
    };
    let entry=await entryGet(editingDate);
    if(!entry) entry={date:editingDate, items:[]};
    entry.items.push(item);
    await entryPut(entry);
    toast('è¿½åŠ ã—ã¾ã—ãŸ');
    openDayModal(editingDate);
    renderCalendar();
    renderTotalAndMuscleCharts(currentMode, editingDate);
  });

  /* ====== è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
  $("#btnSettings").addEventListener('click', ()=>{
    $("#inBodyWeight").value=settings.body_weight||70;
    $("#inGoalDay").value=GOAL.day; 
    $("#inGoalWeek").value=GOAL.week; 
    $("#inGoalMonth").value=GOAL.month;
    $("#dlgSettings").showModal();
    refreshExerciseChips();
  });
  $("#btnCloseSettings").addEventListener('click', ()=>{
    settings.body_weight=+($("#inBodyWeight").value||70);
    GOAL.day=+($("#inGoalDay").value||2000); 
    GOAL.week=+($("#inGoalWeek").value||15000); 
    GOAL.month=+($("#inGoalMonth").value||70000);
    saveSettings(); 
    saveGoals(); 
    $("#dlgSettings").close();
    renderCalendar(); 
    renderTotalAndMuscleCharts(currentMode, settings.last_date||todayISO());
  });

  /* ç¨®ç›®é¸æŠ */
  async function populateExerciseSelect(){
    const sel=$("#selExercise"), list=await exAll();
    sel.innerHTML='<option value="">-- ç¨®ç›®ã‚’é¸æŠ --</option>';
    list.forEach(ex=>{ 
      const opt=document.createElement('option'); 
      opt.value=ex.id; 
      opt.textContent=ex.label; 
      sel.appendChild(opt); 
    });
    sel.addEventListener('change', ()=>{
      const id=sel.value; 
      if(!id) return;
      exGet(id).then(ex=>{ 
        $("#weightBox").style.display=(ex&&ex.type==='weight')?'block':'none'; 
      });
    });
  }

  /* ç¨®ç›®ç®¡ç† */
  // ç­‹è‚‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®åˆæœŸåŒ–
  function initMuscleSelector(){
    const container = $("#muscleSelector");
    container.innerHTML = '';
    
    MUSCLE_ORDER.forEach(muscleKey => {
      const muscleName = MUSCLES[muscleKey];
      const muscleColor = MUSCLE_COLORS[muscleKey];
      
      const row = document.createElement('div');
      row.style.cssText = 'display:grid; grid-template-columns:30px 1fr 80px; gap:8px; align-items:center; padding:6px; background:#fff; border-radius:6px;';
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `muscle_${muscleKey}`;
      checkbox.dataset.muscle = muscleKey;
      checkbox.style.width = '18px';
      checkbox.style.height = '18px';
      checkbox.style.cursor = 'pointer';
      
      // ç­‹è‚‰åï¼ˆè‰²ä»˜ãï¼‰
      const label = document.createElement('label');
      label.htmlFor = `muscle_${muscleKey}`;
      label.style.cssText = `cursor:pointer; font-size:13px; display:flex; align-items:center; gap:6px;`;
      const colorBox = document.createElement('span');
      colorBox.style.cssText = `width:16px; height:16px; border-radius:3px; background:${muscleColor}; border:1px solid var(--line);`;
      label.appendChild(colorBox);
      label.appendChild(document.createTextNode(muscleName));
      
      // å‰²åˆå…¥åŠ›
      const ratioInput = document.createElement('input');
      ratioInput.type = 'number';
      ratioInput.id = `ratio_${muscleKey}`;
      ratioInput.min = '0';
      ratioInput.max = '100';
      ratioInput.step = '5';
      ratioInput.value = '0';
      ratioInput.disabled = true;
      ratioInput.style.cssText = 'padding:6px; border:1px solid var(--line); border-radius:6px; font-size:13px; text-align:right;';
      ratioInput.placeholder = '%';
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚
      checkbox.addEventListener('change', (e) => {
        ratioInput.disabled = !e.target.checked;
        if(e.target.checked && ratioInput.value === '0'){
          ratioInput.value = '10';
        }
        if(!e.target.checked){
          ratioInput.value = '0';
        }
        updateMuscleTotal();
      });
      
      // å‰²åˆå…¥åŠ›å¤‰æ›´æ™‚
      ratioInput.addEventListener('input', updateMuscleTotal);
      
      row.appendChild(checkbox);
      row.appendChild(label);
      row.appendChild(ratioInput);
      container.appendChild(row);
    });
  }
  
  function updateMuscleTotal(){
    let total = 0;
    MUSCLE_ORDER.forEach(muscleKey => {
      const checkbox = $(`#muscle_${muscleKey}`);
      const input = $(`#ratio_${muscleKey}`);
      if(checkbox && checkbox.checked && input){
        total += parseFloat(input.value) || 0;
      }
    });
    
    const totalEl = $("#muscleTotal");
    totalEl.textContent = `åˆè¨ˆ: ${total.toFixed(0)}%`;
    totalEl.style.color = total > 0 ? (Math.abs(total - 100) < 10 ? '#059669' : '#d97706') : '#6b7280';
  }
  
  function getSelectedMuscles(){
    const muscles = {};
    let total = 0;
    
    MUSCLE_ORDER.forEach(muscleKey => {
      const checkbox = $(`#muscle_${muscleKey}`);
      const input = $(`#ratio_${muscleKey}`);
      if(checkbox && checkbox.checked && input){
        const value = parseFloat(input.value) || 0;
        if(value > 0){
          muscles[muscleKey] = value;
          total += value;
        }
      }
    });
    
    // æ­£è¦åŒ–ï¼ˆåˆè¨ˆã‚’1.0ã«ã™ã‚‹ï¼‰
    if(total > 0){
      Object.keys(muscles).forEach(key => {
        muscles[key] = muscles[key] / total;
      });
    }
    
    return muscles;
  }
  
  $("#btnRestoreDefaultEx").addEventListener('click', async()=>{
    if(!confirm('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨®ç›®13ç¨®ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿï¼ˆæ—¢å­˜ã®ç¨®ç›®ã¯æ®‹ã‚Šã¾ã™ï¼‰')) return;
    for(const ex of DEFAULT_EXERCISES){
      await exPut(ex);
    }
    await populateExerciseSelect();
    await refreshExerciseChips();
    toast('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨®ç›®ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
  });
  
  $("#newExType").addEventListener('change',()=>{ 
    $("#bwCoefBox").style.display = ($("#newExType").value==='bodyweight') ? 'block' : 'none'; 
  });
  
  // ç¨®ç›®è¿½åŠ è©³ç´°ãŒé–‹ã‹ã‚ŒãŸã‚‰ç­‹è‚‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
  $("#addExerciseDetails").addEventListener('toggle', (e) => {
    if(e.target.open){
      initMuscleSelector();
    }
  });
  $("#btnAddExercise").addEventListener('click', async ()=>{
    const label = $("#newExLabel").value.trim(); 
    const type = $("#newExType").value; 
    const bwc = +($("#newExBwCoef").value||0.6);
    
    if(!label) return toast('ç¨®ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    
    const muscles = getSelectedMuscles();
    if(Object.keys(muscles).length === 0){
      return toast('ä½¿ç”¨ã™ã‚‹ç­‹è‚‰ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
    }
    
    const id = 'ex_'+Math.random().toString(36).slice(2,9);
    const ex = {id, label, type, muscles}; 
    if(type === 'bodyweight') ex.bw_factor = bwc;
    
    await exPut(ex); 
    
    // ãƒªã‚»ãƒƒãƒˆ
    $("#newExLabel").value = ''; 
    $("#newExBwCoef").value = '0.6';
    MUSCLE_ORDER.forEach(muscleKey => {
      const checkbox = $(`#muscle_${muscleKey}`);
      const input = $(`#ratio_${muscleKey}`);
      if(checkbox) checkbox.checked = false;
      if(input) {
        input.value = '0';
        input.disabled = true;
      }
    });
    updateMuscleTotal();
    
    await refreshExerciseChips(); 
    await populateExerciseSelect(); 
    toast('ç¨®ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  });
  
  async function refreshExerciseChips(){
    const list=await exAll(), box=$("#exerciseChips"); 
    box.innerHTML='';
    list.forEach(ex=>{
      const chip=document.createElement('div'); 
      chip.style.cssText='display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:12px;background:#fff; cursor:pointer; transition:0.2s;';
      chip.onmouseenter = () => chip.style.background = '#f9fafb';
      chip.onmouseleave = () => chip.style.background = '#fff';
      
      const tag=document.createElement('span'); 
      tag.textContent=ex.label+(ex.type==='weight'?'ï¼ˆWï¼‰':'ï¼ˆBWï¼‰'); 
      tag.style.cssText = 'flex:1; font-size:12px; font-weight:800;';
      chip.appendChild(tag);
      
      if(ex.type==='bodyweight'){
        const sp=document.createElement('span'); 
        sp.className='note'; 
        sp.textContent='ä¿‚æ•°';
        const coef=document.createElement('input'); 
        coef.type='number'; 
        coef.step='0.05'; 
        coef.value=ex.bw_factor??0.6; 
        coef.style.width='60px'; 
        coef.style.fontSize='12px'; 
        coef.style.padding='4px';
        coef.onclick = (e) => e.stopPropagation();
        coef.onchange=async(ev)=>{ 
          ex.bw_factor=+ev.target.value||0.6; 
          await exPut(ex); 
          renderCalendar(); 
          renderTotalAndMuscleCharts(currentMode, settings.last_date||todayISO()); 
        };
        chip.appendChild(sp); 
        chip.appendChild(coef);
      }
      
      const editBtn = document.createElement('button');
      editBtn.className = 'btn';
      editBtn.textContent = 'ç·¨é›†';
      editBtn.style.cssText = 'font-size:11px; padding:4px 8px;';
      editBtn.onclick = (e) => {
        e.stopPropagation();
        openEditExerciseModal(ex);
      };
      chip.appendChild(editBtn);
      
      chip.onclick = () => openEditExerciseModal(ex);
      box.appendChild(chip);
    });
  }
  
  // ç¨®ç›®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
  let editingExercise = null;
  
  function initEditMuscleSelector(exercise){
    const container = $("#editMuscleSelector");
    container.innerHTML = '';
    
    const exMuscles = exercise.muscles || {};
    const totalRatio = Object.values(exMuscles).reduce((a,b)=>a+b, 0) || 1;
    
    MUSCLE_ORDER.forEach(muscleKey => {
      const muscleName = MUSCLES[muscleKey];
      const muscleColor = MUSCLE_COLORS[muscleKey];
      const ratio = exMuscles[muscleKey] || 0;
      const percentage = Math.round((ratio / totalRatio) * 100);
      
      const row = document.createElement('div');
      row.style.cssText = 'display:grid; grid-template-columns:30px 1fr 80px; gap:8px; align-items:center; padding:6px; background:#fff; border-radius:6px;';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `edit_muscle_${muscleKey}`;
      checkbox.dataset.muscle = muscleKey;
      checkbox.checked = ratio > 0;
      checkbox.style.width = '18px';
      checkbox.style.height = '18px';
      checkbox.style.cursor = 'pointer';
      
      const label = document.createElement('label');
      label.htmlFor = `edit_muscle_${muscleKey}`;
      label.style.cssText = `cursor:pointer; font-size:13px; display:flex; align-items:center; gap:6px;`;
      const colorBox = document.createElement('span');
      colorBox.style.cssText = `width:16px; height:16px; border-radius:3px; background:${muscleColor}; border:1px solid var(--line);`;
      label.appendChild(colorBox);
      label.appendChild(document.createTextNode(muscleName));
      
      const ratioInput = document.createElement('input');
      ratioInput.type = 'number';
      ratioInput.id = `edit_ratio_${muscleKey}`;
      ratioInput.min = '0';
      ratioInput.max = '100';
      ratioInput.step = '5';
      ratioInput.value = ratio > 0 ? percentage.toString() : '0';
      ratioInput.disabled = ratio === 0;
      ratioInput.style.cssText = 'padding:6px; border:1px solid var(--line); border-radius:6px; font-size:13px; text-align:right;';
      ratioInput.placeholder = '%';
      
      checkbox.addEventListener('change', (e) => {
        ratioInput.disabled = !e.target.checked;
        if(e.target.checked && ratioInput.value === '0'){
          ratioInput.value = '10';
        }
        if(!e.target.checked){
          ratioInput.value = '0';
        }
        updateEditMuscleTotal();
      });
      
      ratioInput.addEventListener('input', updateEditMuscleTotal);
      
      row.appendChild(checkbox);
      row.appendChild(label);
      row.appendChild(ratioInput);
      container.appendChild(row);
    });
    
    updateEditMuscleTotal();
  }
  
  function updateEditMuscleTotal(){
    let total = 0;
    MUSCLE_ORDER.forEach(muscleKey => {
      const checkbox = $(`#edit_muscle_${muscleKey}`);
      const input = $(`#edit_ratio_${muscleKey}`);
      if(checkbox && checkbox.checked && input){
        total += parseFloat(input.value) || 0;
      }
    });
    
    const totalEl = $("#editMuscleTotal");
    totalEl.textContent = `åˆè¨ˆ: ${total.toFixed(0)}%`;
    totalEl.style.color = total > 0 ? (Math.abs(total - 100) < 10 ? '#059669' : '#d97706') : '#6b7280';
  }
  
  function getEditSelectedMuscles(){
    const muscles = {};
    let total = 0;
    
    MUSCLE_ORDER.forEach(muscleKey => {
      const checkbox = $(`#edit_muscle_${muscleKey}`);
      const input = $(`#edit_ratio_${muscleKey}`);
      if(checkbox && checkbox.checked && input){
        const value = parseFloat(input.value) || 0;
        if(value > 0){
          muscles[muscleKey] = value;
          total += value;
        }
      }
    });
    
    if(total > 0){
      Object.keys(muscles).forEach(key => {
        muscles[key] = muscles[key] / total;
      });
    }
    
    return muscles;
  }
  
  function openEditExerciseModal(exercise){
    editingExercise = exercise;
    $("#editExTitle").textContent = `ç¨®ç›®ç·¨é›†ï¼š${exercise.label}`;
    $("#editExLabel").value = exercise.label;
    $("#editExType").value = exercise.type;
    $("#editBwCoefBox").style.display = exercise.type === 'bodyweight' ? 'block' : 'none';
    if(exercise.type === 'bodyweight'){
      $("#editExBwCoef").value = exercise.bw_factor || 0.6;
    }
    
    initEditMuscleSelector(exercise);
    $("#dlgEditExercise").showModal();
  }
  
  $("#btnCloseEditEx").addEventListener('click', () => $("#dlgEditExercise").close());
  
  $("#btnSaveEditEx").addEventListener('click', async () => {
    if(!editingExercise) return;
    
    const label = $("#editExLabel").value.trim();
    if(!label){
      toast('ç¨®ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    const muscles = getEditSelectedMuscles();
    if(Object.keys(muscles).length === 0){
      toast('ä½¿ç”¨ã™ã‚‹ç­‹è‚‰ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
      return;
    }
    
    editingExercise.label = label;
    editingExercise.muscles = muscles;
    if(editingExercise.type === 'bodyweight'){
      editingExercise.bw_factor = +($("#editExBwCoef").value || 0.6);
    }
    
    await exPut(editingExercise);
    await refreshExerciseChips();
    await populateExerciseSelect();
    renderCalendar();
    renderTotalAndMuscleCharts(currentMode, settings.last_date||todayISO());
    
    $("#dlgEditExercise").close();
    toast('ç¨®ç›®ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
  });
  
  $("#btnDeleteEditEx").addEventListener('click', async () => {
    if(!editingExercise) return;
    
    if(!confirm(`ã€Œ${editingExercise.label}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»æ—¢å­˜ã®è¨˜éŒ²ã«ã¯æ®‹ã‚Šã¾ã™`)){
      return;
    }
    
    await exDel(editingExercise.id);
    await refreshExerciseChips();
    await populateExerciseSelect();
    renderCalendar();
    renderTotalAndMuscleCharts(currentMode, settings.last_date||todayISO());
    
    $("#dlgEditExercise").close();
    toast('ç¨®ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
  });

  /* ====== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDå«ã‚€ï¼‰ ====== */
  $("#btnResetAchievements").addEventListener('click', ()=>{
    if(!confirm('é”æˆè¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nâ€»èŠ±ç«æ¼”å‡ºãŒå†åº¦è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™')){
      return;
    }
    achievedGoals = {};
    localStorage.setItem('achievedGoals', JSON.stringify(achievedGoals));
    toast('é”æˆè¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  });
  
  $("#btnTestFireworks").addEventListener('click', ()=>{
    celebrateAchievement(currentMode);
  });
  
  $("#btnExport").addEventListener('click', async ()=>{
    const dump = { 
      user_id: currentUserId,
      exported_at:Date.now(), 
      settings, 
      exercises:await exAll(), 
      entries:await allEntries() 
    };
    const blob=new Blob([JSON.stringify(dump,null,2)],{type:'application/json'});
    const filename = currentUserId ? `workout_${currentUserId}_${new Date().toISOString().slice(0,10)}.json` : `workout_backup_${new Date().toISOString().slice(0,10)}.json`;
    const a=document.createElement('a'); 
    a.href=URL.createObjectURL(blob); 
    a.download=filename; 
    a.click(); 
    
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ—¥æ™‚ã‚’è¨˜éŒ²
    localStorage.setItem('last_backup_reminder', Date.now().toString());
    
    toast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜æ¸ˆã¿ï¼‰');
  });
  
  $("#importFile").addEventListener('change', async (e)=>{
    const f=e.target.files[0]; 
    if(!f) return; 
    let data;
    try{ data=JSON.parse(await f.text()); }catch{ alert('JSONå½¢å¼ãŒä¸æ­£'); return; }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒã‚§ãƒƒã‚¯
    if(data.user_id && data.user_id !== currentUserId){
      if(!confirm(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€Œ${data.user_id}ã€ã¨ç¾åœ¨ã®IDã€Œ${currentUserId}ã€ãŒç•°ãªã‚Šã¾ã™ã€‚\nç¾åœ¨ã®IDã‚’ã€Œ${data.user_id}ã€ã«å¤‰æ›´ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ`)){
        return;
      }
      currentUserId = data.user_id;
      localStorage.setItem('muscle_calendar_user_id', currentUserId);
      await reopenDB();
      updateUserBadge();
    }
    
    if(!confirm('ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) return;
    const t=db.transaction(['entries','exercises'],'readwrite');
    t.objectStore('entries').clear(); 
    t.objectStore('exercises').clear();
    (data.exercises||[]).forEach(x=>t.objectStore('exercises').put(x)); 
    (data.entries||[]).forEach(x=>t.objectStore('entries').put(x));
    await new Promise((res,rej)=>{ t.oncomplete=res; t.onerror=rej; });
    settings=data.settings||settings; 
    saveSettings(); 
    loadGoals();
    await populateExerciseSelect(); 
    await refreshExerciseChips(); 
    await renderCalendar(); 
    renderTotalAndMuscleCharts(currentMode, settings.last_date||todayISO());
    toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†');
  });

  /* ====== ç›®æ¨™é”æˆã®èŠ±ç«æ¼”å‡º ====== */
  let achievedGoals = JSON.parse(localStorage.getItem('achievedGoals') || '{}');
  let audioContext = null;
  
  function initAudioContext(){
    if(!audioContext){
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    return audioContext;
  }
  
  function getGoalKey(mode, pivot){
    if(mode==='day') return `day_${pivot}`;
    if(mode==='week'){
      const d=fromISO(pivot);
      const w=weekRangeFromDate(d);
      return `week_${toISO(w.start)}`;
    }
    const d=fromISO(pivot);
    return `month_${d.getFullYear()}_${d.getMonth()+1}`;
  }
  
  function hasAchieved(mode, pivot){
    const key = getGoalKey(mode, pivot);
    return achievedGoals[key] === true;
  }
  
  function markAchieved(mode, pivot){
    const key = getGoalKey(mode, pivot);
    achievedGoals[key] = true;
    localStorage.setItem('achievedGoals', JSON.stringify(achievedGoals));
  }
  
  // åŠ¹æœéŸ³ç”Ÿæˆï¼ˆWeb Audio APIï¼‰
  function playAchievementSound(){
    const ctx = initAudioContext();
    const now = ctx.currentTime;
    
    // ãƒ¡ãƒ­ãƒ‡ã‚£ãƒ¼éŸ³ç¬¦ï¼ˆãƒ”ãƒ­ãƒªãƒ­ãƒªãƒ³â™ªï¼‰
    const notes = [
      {freq: 523.25, start: 0, duration: 0.15},      // C5
      {freq: 659.25, start: 0.15, duration: 0.15},   // E5
      {freq: 783.99, start: 0.3, duration: 0.15},    // G5
      {freq: 1046.50, start: 0.45, duration: 0.3}    // C6
    ];
    
    notes.forEach(note => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      osc.frequency.value = note.freq;
      osc.type = 'sine';
      
      gain.gain.setValueAtTime(0, now + note.start);
      gain.gain.linearRampToValueAtTime(0.3, now + note.start + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.01, now + note.start + note.duration);
      
      osc.start(now + note.start);
      osc.stop(now + note.start + note.duration);
    });
  }
  
  // èŠ±ç«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  class Firework {
    constructor(canvas, x, y) {
      this.canvas = canvas;
      this.ctx = canvas.getContext('2d');
      this.x = x;
      this.y = y;
      this.particles = [];
      this.hue = Math.random() * 360;
      
      for(let i = 0; i < 50; i++){
        const angle = (Math.PI * 2 * i) / 50;
        const velocity = 2 + Math.random() * 3;
        this.particles.push({
          x: this.x,
          y: this.y,
          vx: Math.cos(angle) * velocity,
          vy: Math.sin(angle) * velocity,
          alpha: 1,
          size: 2 + Math.random() * 2
        });
      }
    }
    
    update(){
      this.particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.1; // é‡åŠ›
        p.alpha -= 0.015;
      });
      return this.particles.some(p => p.alpha > 0);
    }
    
    draw(){
      this.particles.forEach(p => {
        if(p.alpha <= 0) return;
        this.ctx.save();
        this.ctx.globalAlpha = p.alpha;
        this.ctx.fillStyle = `hsl(${this.hue}, 100%, 60%)`;
        this.ctx.beginPath();
        this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        this.ctx.fill();
        this.ctx.restore();
      });
    }
  }
  
  function launchFireworks(){
    const canvas = $('#fireworksCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    canvas.style.display = 'block';
    
    const fireworks = [];
    let launchCount = 0;
    const maxLaunches = 8;
    
    const launchInterval = setInterval(() => {
      if(launchCount >= maxLaunches){
        clearInterval(launchInterval);
        return;
      }
      
      const x = window.innerWidth * (0.2 + Math.random() * 0.6);
      const y = window.innerHeight * (0.2 + Math.random() * 0.4);
      fireworks.push(new Firework(canvas, x, y));
      launchCount++;
    }, 300);
    
    function animate(){
      ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      let hasActive = false;
      fireworks.forEach((fw, idx) => {
        const active = fw.update();
        fw.draw();
        if(active) hasActive = true;
        else fireworks.splice(idx, 1);
      });
      
      if(hasActive || launchCount < maxLaunches){
        requestAnimationFrame(animate);
      } else {
        setTimeout(() => {
          canvas.style.display = 'none';
        }, 1000);
      }
    }
    
    animate();
  }
  
  function celebrateAchievement(mode){
    const modeText = mode === 'day' ? 'æœ¬æ—¥' : mode === 'week' ? 'ä»Šé€±' : 'ä»Šæœˆ';
    $('#achieveText').textContent = `${modeText}ã®ç›®æ¨™é”æˆï¼`;
    
    const msg = $('#achievementMsg');
    msg.style.display = 'block';
    
    playAchievementSound();
    launchFireworks();
    
    setTimeout(() => {
      msg.style.display = 'none';
    }, 3000);
  }

  /* ====== ã‚°ãƒ©ãƒ•ï¼ˆç·é‡ãƒãƒ¼ + å„éƒ¨ä½ãƒãƒ¼ï¼šå›ºå®šé †åºï¼‰ ====== */
  let totalChart=null, muscleChart=null, currentMode='day';
  function modeTitle(m){ return m==='day'?'æ—¥å˜ä½':m==='week'?'é€±å˜ä½':'æœˆå˜ä½'; }

  async function renderTotalAndMuscleCharts(mode, pivot){
    const piv = pivot || settings.last_date || todayISO();
    const { loads, totalLoad, label } = await rangeLoads(mode, piv);

    console.log('ã‚°ãƒ©ãƒ•æç”»:', {mode, totalLoad, loads, label});

    // ç·é‡ãƒãƒ¼
    const goal = GOAL[mode]||0;
    $("#totalLabel").textContent = `ç·ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼š${Math.round(totalLoad).toLocaleString()} kg`;
    $("#goalTag").textContent = `ç›®æ¨™ï¼š${goal.toLocaleString()} kg`;
    
    const achieved = totalLoad >= goal;
    $("#goalTag").classList.toggle('achieved', achieved);
    $("#periodLabel").textContent = label;
    
    // ç›®æ¨™é”æˆæ™‚ã®èŠ±ç«æ¼”å‡ºï¼ˆåˆå›ã®ã¿ï¼‰
    if(achieved && goal > 0 && !hasAchieved(mode, piv)){
      markAchieved(mode, piv);
      setTimeout(() => {
        celebrateAchievement(mode);
      }, 500);
    }

    const tctx = $("#totalBar").getContext('2d');
    if(totalChart) totalChart.destroy();
    totalChart = new Chart(tctx, {
      type:'bar',
      data:{ 
        labels:[`${modeTitle(mode)} åˆè¨ˆ`], 
        datasets:[{ 
          label:'ç·é‡', 
          data:[Math.round(totalLoad)], 
          backgroundColor:'#7dd3fc' 
        }] 
      },
      options:{
        responsive:true, 
        indexAxis:'y',
        plugins:{
          legend:{display:false},
          title:{display:true, text:`ç·é‡ï¼ˆå˜ä½ï¼škgï¼‰`, font:{weight:'bold'}},
          annotation:{ 
            annotations:{ 
              goalLine:{ 
                type:'line', 
                xMin:goal, 
                xMax:goal, 
                borderColor:'rgba(255,215,0,0.9)', 
                borderWidth:2,
                label:{
                  display:true, 
                  content:`ç›®æ¨™ ${goal.toLocaleString()} kg`, 
                  position:'end', 
                  backgroundColor:'rgba(255,215,0,0.2)', 
                  color:'#7a4d00'
                } 
              } 
            } 
          }
        },
        scales:{ 
          x:{ beginAtZero:true, ticks:{ callback:v=>v+' kg' } }, 
          y:{} 
        }
      }
    });

    // å„éƒ¨ä½ãƒãƒ¼ï¼šå›ºå®šé †åºï¼ˆé ­â†’è„šï¼‰+ ãƒ‡ãƒ¼ã‚¿ãªã„éƒ¨ä½ã‚‚è¡¨ç¤º
    const labels2 = MUSCLE_ORDER.map(k => MUSCLES[k]);
    const data2 = MUSCLE_ORDER.map(k => Math.round(loads[k] || 0));
    const colors2 = MUSCLE_ORDER.map(k => MUSCLE_COLORS[k] || '#e5e7eb');

    console.log('ç­‹è‚‰ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿:', {labels2, data2, colors2});

    const mctx = $("#muscleBars").getContext('2d');
    if(muscleChart) muscleChart.destroy();
    muscleChart = new Chart(mctx, {
      type:'bar',
      data:{ 
        labels:labels2, 
        datasets:[{ 
          label:'è·é‡é‡ï¼ˆkgï¼‰', 
          data:data2, 
          backgroundColor:colors2 
        }] 
      },
      options:{
        responsive:true, 
        indexAxis:'y',
        plugins:{ 
          legend:{display:false}, 
          title:{display:true, text:`å„éƒ¨ä½ã®ãƒœãƒªãƒ¥ãƒ¼ãƒ ï¼ˆ${modeTitle(mode)}ãƒ»kgï¼‰`}
        },
        scales:{ 
          x:{ beginAtZero:true, ticks:{ callback:v=>v+' kg' } }
        }
      }
    });
  }

  // åˆ‡æ›¿
  $$('.toggle').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.toggle').forEach(x=>x.classList.remove('active')); 
      btn.classList.add('active');
      currentMode=btn.dataset.mode; 
      renderTotalAndMuscleCharts(currentMode, settings.last_date||todayISO());
    });
  });

  /* ====== ãƒ˜ãƒƒãƒ€æ“ä½œ ====== */
  $("#btnPrev").addEventListener('click', ()=>{ 
    if(view.month===0){view.month=11;view.year--;} else view.month--; 
    renderCalendar(); 
    renderTotalAndMuscleCharts(currentMode, settings.last_date||toISO(new Date(view.year,view.month,1))); 
  });
  $("#btnNext").addEventListener('click', ()=>{ 
    if(view.month===11){view.month=0;view.year++;} else view.month++; 
    renderCalendar(); 
    renderTotalAndMuscleCharts(currentMode, settings.last_date||toISO(new Date(view.year,view.month,1))); 
  });
  $("#btnToday").addEventListener('click', ()=>{ 
    const d=new Date(); 
    view.year=d.getFullYear(); 
    view.month=d.getMonth(); 
    renderCalendar(); 
    settings.last_date=todayISO(); 
    saveSettings(); 
    renderTotalAndMuscleCharts(currentMode, settings.last_date); 
  });
  $("#btnAddToday").addEventListener('click', ()=>{ 
    openDayModal(todayISO()); 
    settings.last_date=todayISO(); 
    saveSettings(); 
    renderTotalAndMuscleCharts(currentMode, settings.last_date); 
  });

  /* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
  let toastTimer=null; 
  function toast(msg){ 
    const t=$("#toast"); 
    t.textContent=msg; 
    t.style.display='block'; 
    if(toastTimer)clearTimeout(toastTimer); 
    toastTimer=setTimeout(()=>t.style.display='none',2000); 
  }

  /* ====== åˆæœŸåŒ– ====== */
  (async function init(){
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒãªã„å ´åˆã¯åˆå›è¨­å®š
    if(!currentUserId){
      showUserIdModal();
    }
    
    // åˆå›ã‚¿ãƒƒãƒã§AudioContextåˆæœŸåŒ–ï¼ˆiOSå¯¾å¿œï¼‰
    document.body.addEventListener('click', initAudioContext, {once: true});
    
    updateUserBadge();
    loadSettings();
    loadGoals();
    db = await openDB();
    
    if(typeof settings.body_weight!=='number'){ settings.body_weight=70; }
    if(!settings.last_date) settings.last_date=todayISO(); 
    saveSettings();

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨®ç›®ç™»éŒ²ï¼ˆç¨®ç›®ãŒ0ã®å ´åˆã¯å¸¸ã«è¿½åŠ ï¼‰
    const existingEx = await exAll();
    if(existingEx.length === 0){
      console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨®ç›®ã‚’ç™»éŒ²ä¸­...');
      for(const ex of DEFAULT_EXERCISES){
        await exPut(ex);
      }
      console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨®ç›®ã®ç™»éŒ²å®Œäº†');
    }

    await populateExerciseSelect();
    await refreshExerciseChips();
    await renderCalendar();
    await renderTotalAndMuscleCharts(currentMode, settings.last_date);
    
    // ãƒ‡ãƒ¼ã‚¿ä¿è­·ã®æ³¨æ„å–šèµ·ï¼ˆåˆå›ã®ã¿ï¼‰
    const backupReminder = localStorage.getItem('backup_reminder_shown');
    if(!backupReminder){
      setTimeout(() => {
        if(confirm('ğŸ“± é‡è¦ãªãŠçŸ¥ã‚‰ã›\n\nã“ã®ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚\nSafariã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã‚„ã‚¢ãƒ—ãƒªå‰Šé™¤ã§ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚\n\nå®šæœŸçš„ã«ã€Œè¨­å®š â†’ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚\n\nã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä»Šå¾Œè¡¨ç¤ºã—ãªã„å ´åˆã¯ã€ŒOKã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚')){
          localStorage.setItem('backup_reminder_shown', 'true');
        }
      }, 2000);
    }
    
    // 7æ—¥ã”ã¨ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿ƒã™
    const lastBackupReminder = localStorage.getItem('last_backup_reminder');
    const now = Date.now();
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    
    if(!lastBackupReminder || (now - parseInt(lastBackupReminder)) > sevenDays){
      const entries = await allEntries();
      if(entries.length > 0){
        setTimeout(() => {
          if(confirm('ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ãŠå‹§ã‚\n\nå‰å›ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰7æ—¥ä»¥ä¸ŠçµŒéã—ã¦ã„ã¾ã™ã€‚\nãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚Šã¾ã™ã‹ï¼Ÿ')){
            $('#btnSettings').click();
            setTimeout(() => {
              const exportBtn = $('#btnExport');
              exportBtn.style.animation = 'pulse 1s ease-in-out 3';
              exportBtn.scrollIntoView({behavior: 'smooth', block: 'center'});
            }, 500);
          }
          localStorage.setItem('last_backup_reminder', now.toString());
        }, 5000);
      }
    }
  })();
  </script>
</body>
</html>
